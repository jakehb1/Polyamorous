<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Polygram ¬∑ Trade Predictions</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    @font-face {
      font-family: 'Benzin';
      src: url('https://fonts.cdnfonts.com/s/29189/Benzin-ExtraBold.woff') format('woff');
      font-weight: 800;
      font-style: normal;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg: #d4f5ed;
      --bg-light: #e8faf5;
      --card: #f0fdf9;
      --accent: #3ECFB2;
      --accent-dark: #1a3a34;
      --text: #1a3a34;
      --text-secondary: #5a7a74;
      --text-dim: #8aa9a3;
      --border: #b8e8dd;
      --yes-green: #22c55e;
      --yes-bg: rgba(34, 197, 94, 0.15);
      --no-red: #ef4444;
      --no-bg: rgba(239, 68, 68, 0.15);
    }
    
    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding-bottom: 80px;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px 12px;
      background: var(--bg);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      font-family: 'Benzin', sans-serif;
      font-size: 22px;
      font-weight: 800;
      color: var(--accent-dark);
    }

    .header-balance {
      display: flex;
      gap: 16px;
    }

    .balance-item {
      text-align: right;
    }

    .balance-label {
      font-size: 10px;
      color: var(--text-secondary);
      text-transform: uppercase;
    }

    .balance-value {
      font-size: 14px;
      font-weight: 600;
      color: var(--accent-dark);
    }

    /* Category Tabs */
    .category-tabs {
      display: flex;
      gap: 4px;
      padding: 0 16px 8px;
      overflow-x: auto;
      scrollbar-width: none;
    }

    .category-tabs::-webkit-scrollbar { display: none; }

    .category-tab {
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      background: transparent;
      border: none;
      cursor: pointer;
      white-space: nowrap;
      border-radius: 20px;
      transition: all 0.2s;
    }

    .category-tab.active {
      background: var(--accent-dark);
      color: white;
    }

    /* Sub Filters */
    .sub-filters {
      display: flex;
      gap: 8px;
      padding: 8px 16px 16px;
      overflow-x: auto;
      scrollbar-width: none;
    }

    .sub-filters::-webkit-scrollbar { display: none; }

    .sub-filter {
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 20px;
      cursor: pointer;
      white-space: nowrap;
    }

    .sub-filter.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    /* Main Content */
    .main-content {
      padding: 0 16px;
    }

    /* Wallet Card */
    .wallet-card {
      background: var(--card);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 16px;
      border: 1px solid var(--border);
    }

    .wallet-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .wallet-title {
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .wallet-badge {
      background: var(--accent);
      color: white;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }

    .wallet-balance {
      font-size: 36px;
      font-weight: 700;
      color: var(--accent-dark);
      margin: 8px 0;
    }

    .wallet-subtitle {
      font-size: 13px;
      color: var(--text-dim);
    }

    .wallet-addresses {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .wallet-row {
      background: var(--bg-light);
      border-radius: 12px;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .wallet-row-left {
      flex: 1;
      min-width: 0;
    }

    .wallet-label {
      font-size: 11px;
      color: var(--text-secondary);
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .wallet-address {
      font-size: 13px;
      font-family: 'SF Mono', monospace;
      color: var(--text);
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .copy-btn {
      padding: 8px;
      background: transparent;
      border: none;
      cursor: pointer;
      color: var(--text-secondary);
      border-radius: 8px;
    }

    .copy-btn:active {
      background: var(--accent);
      color: white;
    }

    .wallet-status {
      text-align: center;
      padding: 12px;
      font-size: 14px;
      color: var(--accent-dark);
      background: var(--bg-light);
      border-radius: 12px;
      margin-top: 12px;
    }

    /* Event Cards */
    .events-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .event-card {
      background: var(--card);
      border-radius: 16px;
      padding: 16px;
      border: 1px solid var(--border);
    }

    .event-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .event-icon {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      object-fit: cover;
      background: var(--bg-light);
    }

    .event-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
      flex: 1;
      line-height: 1.3;
    }

    .outcome-row {
      display: flex;
      align-items: center;
      padding: 10px 0;
      border-top: 1px solid var(--border);
    }

    .outcome-name {
      flex: 1;
      font-size: 14px;
      color: var(--text);
    }

    .outcome-percent {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-right: 12px;
      min-width: 40px;
      text-align: right;
    }

    .outcome-buttons {
      display: flex;
      gap: 8px;
    }

    .outcome-btn {
      padding: 6px 14px;
      font-size: 12px;
      font-weight: 600;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: all 0.15s;
    }

    .outcome-btn.yes {
      background: var(--accent);
      color: white;
    }

    .outcome-btn.no {
      background: var(--accent-dark);
      color: white;
    }

    .event-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid var(--border);
    }

    .event-volume {
      font-size: 12px;
      color: var(--text-dim);
    }

    /* Bottom Nav */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-around;
      background: var(--card);
      border-top: 1px solid var(--border);
      padding: 10px 0;
      padding-bottom: max(10px, env(safe-area-inset-bottom));
      z-index: 1000;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-secondary);
      font-size: 11px;
      font-weight: 500;
      padding: 4px 20px;
    }

    .nav-item.active {
      color: var(--accent-dark);
    }

    .nav-icon {
      width: 24px;
      height: 24px;
    }

    /* More Menu */
    .more-menu {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg);
      z-index: 2000;
      padding: 20px;
    }

    .more-menu.visible { display: block; }

    .more-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }

    .more-wallet {
      font-size: 16px;
      color: var(--text-secondary);
      font-family: monospace;
    }

    .close-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--card);
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 24px;
      cursor: pointer;
    }

    .menu-item {
      padding: 18px 0;
      font-size: 18px;
      font-weight: 500;
      color: var(--text);
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
    }

    /* Trade Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 3000;
      align-items: flex-end;
    }

    .modal-overlay.visible { display: flex; }

    .modal {
      background: var(--card);
      border-radius: 24px 24px 0 0;
      padding: 24px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
    }

    .modal-handle {
      width: 40px;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      margin: 0 auto 20px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .modal-market {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 20px;
    }

    .trade-sides {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }

    .trade-side {
      padding: 16px;
      border-radius: 16px;
      border: 2px solid var(--border);
      background: var(--bg-light);
      cursor: pointer;
      text-align: center;
    }

    .trade-side.yes.active {
      border-color: var(--yes-green);
      background: var(--yes-bg);
    }

    .trade-side.no.active {
      border-color: var(--no-red);
      background: var(--no-bg);
    }

    .trade-side-label {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .trade-side.yes .trade-side-label { color: var(--yes-green); }
    .trade-side.no .trade-side-label { color: var(--no-red); }

    .trade-side-price {
      font-size: 28px;
      font-weight: 700;
    }

    .trade-side.yes .trade-side-price { color: var(--yes-green); }
    .trade-side.no .trade-side-price { color: var(--no-red); }

    .amount-label {
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .amount-input {
      width: 100%;
      padding: 16px;
      font-size: 24px;
      font-weight: 600;
      text-align: center;
      background: var(--bg-light);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      outline: none;
      margin-bottom: 16px;
    }

    .trade-summary {
      background: var(--bg-light);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      font-size: 14px;
    }

    .summary-label { color: var(--text-secondary); }
    .summary-value { font-weight: 600; }

    .trade-btn {
      width: 100%;
      padding: 16px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      background: var(--accent);
      color: white;
      cursor: pointer;
    }

    .trade-btn:disabled {
      background: var(--border);
      color: var(--text-dim);
    }

    /* Views */
    .view { display: none; }
    .view.active { display: block; }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-dim);
    }

    /* Portfolio */
    .portfolio-tabs {
      display: flex;
      gap: 24px;
      padding: 16px 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 16px;
    }

    .portfolio-tab {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      background: none;
      border: none;
      cursor: pointer;
      padding-bottom: 8px;
      border-bottom: 2px solid transparent;
    }

    .portfolio-tab.active {
      color: var(--accent-dark);
      border-bottom-color: var(--accent);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-dim);
    }

    /* Splash */
    .splash {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.3s;
    }

    .splash.hidden { opacity: 0; pointer-events: none; }

    .splash-logo {
      font-family: 'Benzin', sans-serif;
      font-size: 36px;
      color: var(--accent-dark);
    }
  </style>
</head>
<body>
  <!-- Splash -->
  <div class="splash" id="splash">
    <div class="splash-logo">Polygram</div>
  </div>

  <!-- Header -->
  <header class="header">
    <div class="logo">Polygram</div>
    <div class="header-balance">
      <div class="balance-item">
        <div class="balance-label">USDC</div>
        <div class="balance-value" id="headerBalance">$0.00</div>
      </div>
    </div>
  </header>

  <!-- Category Tabs -->
  <div class="category-tabs">
    <button class="category-tab active" data-category="trending">üî• Trending</button>
    <button class="category-tab" data-category="new">üÜï New</button>
    <button class="category-tab" data-category="politics">üèõ Politics</button>
    <button class="category-tab" data-category="sports">‚öΩ Sports</button>
    <button class="category-tab" data-category="crypto">‚Çø Crypto</button>
  </div>

  <!-- Sub Filters -->
  <div class="sub-filters">
    <button class="sub-filter active">All</button>
    <button class="sub-filter">Breaking</button>
    <button class="sub-filter">Elections</button>
    <button class="sub-filter">Markets</button>
  </div>

  <!-- Home View -->
  <div class="view active" id="homeView">
    <div class="main-content">
      <!-- Wallet Card -->
      <div class="wallet-card">
        <div class="wallet-header">
          <div class="wallet-title">üí∞ Portfolio</div>
          <div class="wallet-badge" id="usdcBadge">$0</div>
        </div>
        <div class="wallet-balance" id="portfolioBalance">$0.00</div>
        <div class="wallet-subtitle">USDC: $0.00 | Positions: $0.00</div>
        
        <div class="wallet-addresses">
          <div class="wallet-row">
            <div class="wallet-row-left">
              <div class="wallet-label">‚óé SOL Wallet</div>
              <div class="wallet-address" id="solAddress">Loading...</div>
            </div>
            <button class="copy-btn" id="copySolBtn">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
            </button>
          </div>
          <div class="wallet-row">
            <div class="wallet-row-left">
              <div class="wallet-label">$ USDC Wallet</div>
              <div class="wallet-address" id="usdcAddress">Loading...</div>
            </div>
            <button class="copy-btn" id="copyUsdcBtn">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
            </button>
          </div>
        </div>
        <div class="wallet-status" id="walletStatus">‚úì Wallets ready - fund to trade</div>
      </div>

      <!-- Markets -->
      <div class="events-container" id="eventsContainer">
        <div class="loading">Loading markets...</div>
      </div>
    </div>
  </div>

  <!-- Portfolio View -->
  <div class="view" id="portfolioView">
    <div class="main-content">
      <div class="wallet-card">
        <div class="wallet-header">
          <div class="wallet-title">üìà Portfolio Value</div>
          <div class="wallet-badge">$0</div>
        </div>
        <div class="wallet-balance">$0.00</div>
        <div class="wallet-subtitle">Today</div>
      </div>

      <div class="portfolio-tabs">
        <button class="portfolio-tab active">Positions</button>
        <button class="portfolio-tab">Open Orders</button>
        <button class="portfolio-tab">History</button>
      </div>

      <div class="empty-state">No positions yet. Start trading!</div>
    </div>
  </div>

  <!-- More Menu -->
  <div class="more-menu" id="moreMenu">
    <div class="more-header">
      <div class="more-wallet" id="menuWalletAddr">0x0000...0000</div>
      <button class="close-btn" id="closeMenuBtn">√ó</button>
    </div>
    <button class="menu-item" id="menuProfile">Profile</button>
    <button class="menu-item" id="menuAddFunds">Add Funds</button>
    <button class="menu-item" id="menuCopyAddr">Copy Wallet Address</button>
    <button class="menu-item" id="menuLeaderboard">Leaderboard</button>
    <button class="menu-item" id="menuActivity">Activity</button>
  </div>

  <!-- Bottom Nav -->
  <nav class="bottom-nav">
    <button class="nav-item active" id="navHome">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
        <polyline points="9 22 9 12 15 12 15 22"></polyline>
      </svg>
      Home
    </button>
    <button class="nav-item" id="navPortfolio">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
        <polyline points="17 6 23 6 23 12"></polyline>
      </svg>
      <span id="navBalance">$0</span>
    </button>
    <button class="nav-item" id="navMore">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
      More
    </button>
  </nav>

  <!-- Trade Modal -->
  <div class="modal-overlay" id="tradeModal">
    <div class="modal">
      <div class="modal-handle"></div>
      <h3 class="modal-title">Place Trade</h3>
      <p class="modal-market" id="modalMarket">Select position</p>
      
      <div class="trade-sides">
        <div class="trade-side yes active" data-side="yes">
          <div class="trade-side-label">Yes</div>
          <div class="trade-side-price" id="yesPrice">--¬¢</div>
        </div>
        <div class="trade-side no" data-side="no">
          <div class="trade-side-label">No</div>
          <div class="trade-side-price" id="noPrice">--¬¢</div>
        </div>
      </div>

      <div class="amount-label">Amount (USDC)</div>
      <input type="number" class="amount-input" id="tradeAmount" placeholder="0.00" />

      <div class="trade-summary">
        <div class="summary-row">
          <span class="summary-label">Shares</span>
          <span class="summary-value" id="tradeShares">0.00</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Avg Price</span>
          <span class="summary-value" id="tradeAvgPrice">--¬¢</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Potential Return</span>
          <span class="summary-value" id="tradePotential">$0.00</span>
        </div>
      </div>

      <button class="trade-btn" id="tradeSubmit" disabled>Enter Amount</button>
    </div>
  </div>

  <script>
    const state = {
      telegramId: null,
      wallet: null,
      markets: [],
      selectedMarket: null,
      tradeSide: 'yes',
    };

    const WALLET_KEY = 'polygram_wallet';

    // Init Telegram
    function initTelegram() {
      if (window.Telegram?.WebApp) {
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        state.telegramId = tg.initDataUnsafe?.user?.id || `demo_${Date.now()}`;
      } else {
        state.telegramId = `demo_${Date.now()}`;
      }
    }

    // Wallet
    function generateSolAddress() {
      const chars = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
      let r = '';
      for (let i = 0; i < 44; i++) r += chars[Math.floor(Math.random() * chars.length)];
      return r;
    }

    function getOrCreateWallet() {
      const stored = localStorage.getItem(WALLET_KEY);
      if (stored) {
        try {
          const w = JSON.parse(stored);
          if (w.polygon) return w;
        } catch {}
      }
      const eth = ethers.Wallet.createRandom();
      const wallet = {
        polygon: eth.address,
        pk: eth.privateKey,
        solana: generateSolAddress(),
        created: new Date().toISOString(),
      };
      localStorage.setItem(WALLET_KEY, JSON.stringify(wallet));
      return wallet;
    }

    function shortAddr(addr) {
      return addr ? `${addr.slice(0, 10)}...${addr.slice(-6)}` : '...';
    }

    async function setupCopy(btnId, text) {
      document.getElementById(btnId).onclick = async () => {
        await navigator.clipboard.writeText(text);
        document.getElementById('walletStatus').textContent = '‚úì Address copied!';
        setTimeout(() => {
          document.getElementById('walletStatus').textContent = '‚úì Wallets ready - fund to trade';
        }, 2000);
      };
    }

    // Markets
    async function fetchMarkets(category = 'trending') {
      const container = document.getElementById('eventsContainer');
      container.innerHTML = '<div class="loading">Loading markets...</div>';

      try {
        const resp = await fetch(`/api/markets?kind=${category}&limit=15`);
        const data = await resp.json();
        
        if (data.markets?.length) {
          state.markets = data.markets;
          renderMarkets(data.markets);
        } else {
          container.innerHTML = '<div class="loading">No markets found</div>';
        }
      } catch (err) {
        container.innerHTML = '<div class="loading">Error loading markets</div>';
      }
    }

    function renderMarkets(markets) {
      const container = document.getElementById('eventsContainer');
      
      container.innerHTML = markets.map(m => {
        const prices = m.outcomePrices || [];
        const yesPrice = prices[0] ? Math.round(parseFloat(prices[0]) * 100) : '--';
        const noPrice = prices[1] ? Math.round(parseFloat(prices[1]) * 100) : '--';
        const vol = formatVolume(m.volume);
        
        return `
          <div class="event-card">
            <div class="event-header">
              ${m.image ? `<img class="event-icon" src="${m.image}" onerror="this.style.display='none'" />` : ''}
              <div class="event-title">${m.question}</div>
            </div>
            <div class="outcome-row">
              <div class="outcome-name">Yes</div>
              <div class="outcome-percent">${yesPrice}%</div>
              <div class="outcome-buttons">
                <button class="outcome-btn yes" data-id="${m.id}" data-side="yes">Yes</button>
                <button class="outcome-btn no" data-id="${m.id}" data-side="no">No</button>
              </div>
            </div>
            <div class="event-footer">
              <div class="event-volume">${vol} Vol.</div>
            </div>
          </div>
        `;
      }).join('');

      container.querySelectorAll('.outcome-btn').forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          const market = state.markets.find(m => m.id === btn.dataset.id);
          if (market) openTradeModal(market, btn.dataset.side);
        };
      });
    }

    function formatVolume(n) {
      if (!n) return '$0';
      if (n >= 1e6) return `$${(n/1e6).toFixed(1)}M`;
      if (n >= 1e3) return `$${(n/1e3).toFixed(0)}K`;
      return `$${Math.round(n)}`;
    }

    // Trade Modal
    function openTradeModal(market, side = 'yes') {
      state.selectedMarket = market;
      state.tradeSide = side;

      const prices = market.outcomePrices || [];
      document.getElementById('modalMarket').textContent = market.question;
      document.getElementById('yesPrice').textContent = `${Math.round((prices[0]||0.5)*100)}¬¢`;
      document.getElementById('noPrice').textContent = `${Math.round((prices[1]||0.5)*100)}¬¢`;
      document.getElementById('tradeAmount').value = '';
      
      document.querySelectorAll('.trade-side').forEach(el => {
        el.classList.toggle('active', el.dataset.side === side);
      });

      updateTradeSummary();
      document.getElementById('tradeModal').classList.add('visible');
    }

    function updateTradeSummary() {
      const amt = parseFloat(document.getElementById('tradeAmount').value) || 0;
      const prices = state.selectedMarket?.outcomePrices || [];
      const price = parseFloat(prices[state.tradeSide === 'yes' ? 0 : 1]) || 0.5;
      
      const shares = price > 0 ? (amt / price).toFixed(2) : 0;
      document.getElementById('tradeShares').textContent = shares;
      document.getElementById('tradeAvgPrice').textContent = `${Math.round(price*100)}¬¢`;
      document.getElementById('tradePotential').textContent = `$${(shares * 1).toFixed(2)}`;
      
      const btn = document.getElementById('tradeSubmit');
      btn.disabled = amt <= 0;
      btn.textContent = amt > 0 ? `Buy ${state.tradeSide.toUpperCase()} ¬∑ $${amt.toFixed(2)}` : 'Enter Amount';
    }

    // Navigation
    function switchView(view) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      
      document.getElementById(view === 'home' ? 'homeView' : 'portfolioView').classList.add('active');
      document.getElementById(view === 'home' ? 'navHome' : 'navPortfolio').classList.add('active');
    }

    // Init
    async function init() {
      initTelegram();
      state.wallet = getOrCreateWallet();

      // Display wallet
      document.getElementById('solAddress').textContent = shortAddr(state.wallet.solana);
      document.getElementById('usdcAddress').textContent = shortAddr(state.wallet.polygon);
      document.getElementById('menuWalletAddr').textContent = shortAddr(state.wallet.polygon);

      // Copy buttons
      setupCopy('copySolBtn', state.wallet.solana);
      setupCopy('copyUsdcBtn', state.wallet.polygon);

      // Category tabs
      document.querySelectorAll('.category-tab').forEach(tab => {
        tab.onclick = () => {
          document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          fetchMarkets(tab.dataset.category);
        };
      });

      // Sub filters
      document.querySelectorAll('.sub-filter').forEach(f => {
        f.onclick = () => {
          document.querySelectorAll('.sub-filter').forEach(x => x.classList.remove('active'));
          f.classList.add('active');
        };
      });

      // Nav
      document.getElementById('navHome').onclick = () => switchView('home');
      document.getElementById('navPortfolio').onclick = () => switchView('portfolio');
      document.getElementById('navMore').onclick = () => document.getElementById('moreMenu').classList.add('visible');

      // More menu
      document.getElementById('closeMenuBtn').onclick = () => document.getElementById('moreMenu').classList.remove('visible');
      document.getElementById('menuCopyAddr').onclick = async () => {
        await navigator.clipboard.writeText(state.wallet.polygon);
        alert('Address copied!');
      };
      document.getElementById('menuAddFunds').onclick = async () => {
        await navigator.clipboard.writeText(state.wallet.polygon);
        alert(`Send USDC (Polygon) to:\n${state.wallet.polygon}`);
      };

      // Trade modal
      document.getElementById('tradeModal').onclick = (e) => {
        if (e.target.id === 'tradeModal') document.getElementById('tradeModal').classList.remove('visible');
      };

      document.querySelectorAll('.trade-side').forEach(side => {
        side.onclick = () => {
          document.querySelectorAll('.trade-side').forEach(s => s.classList.remove('active'));
          side.classList.add('active');
          state.tradeSide = side.dataset.side;
          updateTradeSummary();
        };
      });

      document.getElementById('tradeAmount').oninput = updateTradeSummary;
      document.getElementById('tradeSubmit').onclick = () => alert('Coming soon! Fund wallet first.');

      // Load markets
      await fetchMarkets('trending');
      
      // Hide splash
      setTimeout(() => document.getElementById('splash').classList.add('hidden'), 500);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
